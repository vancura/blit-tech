---
description: Blit-Tech WebGPU game engine - main project rules and conventions
globs: ["**/*.ts", "**/*.js", "**/*.mjs", "**/*.wgsl", "**/*.md"]
alwaysApply: true
---

# Blit-Tech Project Rules

Blit-Tech is a lightweight WebGPU retro game engine for TypeScript, inspired by RetroBlit.
It provides pixel-perfect 2D rendering with a clean, fantasy-console-style API.

## CRITICAL RULES

### No Emoji

NEVER use emoji in:
- Source code (comments, strings, identifiers)
- Documentation (markdown files, JSDoc)
- Commit messages
- Pull request titles and descriptions
- Error messages or log output

This rule has no exceptions. Use plain text descriptions instead.

### Integer Coordinates

All rendering uses integer positions. The engine is designed for pixel-perfect graphics:
- Use `Vector2i` for all positions and sizes
- Use `Rect2i` for all rectangular regions
- Values are automatically floored to integers
- Never use floating-point coordinates for rendering

### Performance First

The engine targets 60 FPS with thousands of sprites:
- Minimize allocations in update/render loops
- Reuse buffers and objects where possible
- Batch draw calls (sprites batched by texture)
- Avoid creating objects in hot paths - use object pools or pre-allocated arrays

## Architecture

### Public API

All engine functionality is accessed through the static `BT` namespace:

```typescript
// Correct - use BT namespace
BT.clear(Color32.black());
BT.drawSprite(sheet, srcRect, destPos);
BT.cameraSet(new Vector2i(100, 50));

// Wrong - never access internal classes directly
BTAPI.instance.renderer.drawSprite(...);
```

### Game Interface

Games implement `IBlitTechGame`:

```typescript
interface IBlitTechGame {
    queryHardware(): HardwareSettings;  // Called first, configure display
    initialize(): Promise<boolean>;      // Load assets, return true if ready
    update(): void;                       // Fixed timestep (60 FPS default)
    render(): void;                       // Variable rate rendering
}
```

### Internal Architecture

- `BTAPI` - Internal singleton managing all subsystems
- `Renderer` - WebGPU rendering with dual pipelines (primitives + sprites)
- Asset classes (`SpriteSheet`, `BitmapFont`) with lazy GPU resource creation

## Core Types

### Vector2i

Integer 2D vector for positions and sizes:
- Constructor auto-floors values: `new Vector2i(1.7, 2.3)` becomes `(1, 2)`
- Has `width`/`height` aliases for `x`/`y`
- Arithmetic methods return new instances: `pos.add(offset)`
- Static constructors: `Vector2i.zero()`, `Vector2i.one()`, etc.

### Rect2i

Integer rectangle for regions:
- Properties: `x`, `y`, `width`, `height`
- Computed: `min`, `max`, `center`, `position`, `size`
- Methods: `contains()`, `intersects()`, `intersection()`, `intersectionDepth()`

### Color32

32-bit RGBA color (0-255 per channel):
- Constructor auto-clamps values
- Conversions: `toFloat32Array()`, `toUint32()`, `toHex()`
- Static colors: `Color32.white()`, `Color32.black()`, `Color32.red()`, etc.
- Parsing: `Color32.fromHex('#FF0000')`, `Color32.fromRGB(255, 0, 0)`

## Rendering

### Dual Pipeline Architecture

The renderer uses two separate WebGPU pipelines:

1. **Primitives Pipeline** - Colored geometry (pixels, lines, rectangles)
   - Vertex format: position (x, y) + color (r, g, b, a)
   - Max vertices: 100,000 per frame
   - Used by: `drawPixel`, `drawLine`, `drawRect`, `drawRectFill`

2. **Sprites Pipeline** - Textured quads with tinting
   - Vertex format: position + UV + tint color
   - Max vertices: 50,000 per frame (4096 quads)
   - Nearest-neighbor sampling for pixel-perfect rendering
   - Automatic batching by texture

### Drawing Order

Draw calls are rendered in order within each frame:
1. `BT.clear()` sets background color
2. Primitives and sprites interleave based on call order
3. Frame ends with `endFrame()` which flushes all batches

### Camera System

Camera offset affects all drawing:
```typescript
BT.cameraSet(new Vector2i(100, 50));  // Scroll world
BT.cameraGet();                        // Get current offset
BT.cameraReset();                      // Reset to (0, 0)
```

## Assets

### SpriteSheet

Load images as GPU textures:
```typescript
const sheet = await SpriteSheet.load('sprites.png');
BT.drawSprite(sheet, new Rect2i(0, 0, 16, 16), new Vector2i(100, 100));
```

- Textures created lazily on first use
- Format: `rgba8unorm`
- Sampling: nearest-neighbor (pixel-perfect)

### BitmapFont

Custom `.btfont` JSON format:
```typescript
const font = await BitmapFont.load('fonts/MyFont.btfont');
BT.printFont(font, new Vector2i(10, 10), 'Hello World', Color32.white());
```

- Variable-width glyphs with per-character offsets
- Unicode support
- Embedded (base64) or external texture references

## Future: Palette System

The engine will support VGA Mode 13h style palettized rendering:

- R8Uint index framebuffer (256 colors max)
- Palette as uniform buffer (256 x vec4<f32>)
- Palette effects: rotation/cycling, fade, swap, flash
- Configurable sizes: 256, 128, 64, 32, 16, 8, 4 colors
- Dual-mode: RGBA and indexed sprites can coexist

When implementing palette features:
- Index framebuffer separate from RGBA framebuffer
- Palette lookup in fragment shader
- Palette changes don't require redrawing - just update uniform

## Code Style

Enforced by Biome and ESLint:

- **Indent**: 4 spaces
- **Line width**: 120 characters max
- **Quotes**: Single quotes for strings
- **Semicolons**: Always required
- **Trailing commas**: Always (including function parameters)
- **Arrow parens**: Always use parentheses

### Imports

Use type imports for type-only imports:
```typescript
// Correct
import type { HardwareSettings } from './IBlitTechGame';
import { Vector2i, Rect2i } from '../utils/Vector2i';

// Wrong
import { HardwareSettings } from './IBlitTechGame';  // If only used as type
```

### JSDoc

Required for public APIs:
```typescript
/**
 * Draws a sprite from a sprite sheet at the specified position.
 * @param sheet - The sprite sheet containing the source texture
 * @param srcRect - Source rectangle in the sprite sheet (pixels)
 * @param destPos - Destination position on screen
 * @param tint - Optional tint color (default: white)
 */
export function drawSprite(
    sheet: SpriteSheet,
    srcRect: Rect2i,
    destPos: Vector2i,
    tint?: Color32
): void;
```

## File Organization

```
src/
  BlitTech.ts          # Public API (BT namespace exports)
  main.ts              # Dev entry point
  core/
    BTAPI.ts           # Internal singleton
    IBlitTechGame.ts   # Game interface
  render/
    Renderer.ts        # WebGPU renderer
  assets/
    AssetLoader.ts     # Image loading with caching
    SpriteSheet.ts     # GPU texture wrapper
    BitmapFont.ts      # Bitmap font system
  utils/
    Vector2i.ts        # Integer 2D vector
    Rect2i.ts          # Integer rectangle
    Color32.ts         # 32-bit color
```

## Git Commits

### Conventional Commits

All commits must follow the Conventional Commits format:

```
<type>(<scope>): <description>

[optional body]

[optional footer(s)]
```

**Rules:**
- Header (first line) max 100 characters
- Subject must be lowercase
- Subject must not end with period

**Types:**
- `feat` - New feature
- `fix` - Bug fix
- `docs` - Documentation only
- `style` - Formatting, no code change
- `refactor` - Code change that neither fixes a bug nor adds a feature
- `perf` - Performance improvement
- `test` - Adding or updating tests
- `build` - Build system or dependencies
- `ci` - CI configuration
- `chore` - Other changes (e.g., tooling)

**Suggested Scopes:**
- `renderer` - Rendering system
- `camera` - Camera system
- `assets` - Asset loading
- `api` - Public API (BT namespace)
- `utils` - Utility classes
- `examples` - Example projects
- `ci` - CI/CD configuration
- `docs` - Documentation

**Examples:**
```
feat(renderer): add circle primitive drawing
fix(assets): handle missing texture gracefully
perf(renderer): reduce buffer uploads per frame
docs: update API reference section
```

### Signed-Off Commits

All commits must include a sign-off line (DCO - Developer Certificate of Origin):

```
Signed-off-by: Your Name <your.email@example.com>
```

Use `git commit -s` to automatically add the sign-off.

### AI-Assisted Commits

When AI tools are used to write code or commit messages, include the AI trailer:

```
feat(palette): implement color cycling effect

Add palette rotation with configurable speed and range.
Supports both forward and reverse cycling directions.

Signed-off-by: Your Name <your.email@example.com>

Co-Authored-By: Claude <noreply@anthropic.com>
```

This applies to any AI assistance (Cursor, Claude, GitHub Copilot, etc.).

## Common Mistakes to Avoid

1. **Using floating-point coordinates** - Always use Vector2i/Rect2i
2. **Creating objects in render loop** - Pre-allocate or use pools
3. **Accessing BTAPI directly** - Use BT namespace
4. **Forgetting async in initialize()** - Asset loading is async
5. **Using emoji** - Never allowed anywhere
6. **Skipping JSDoc** - Required for public functions/classes
7. **Using `any` type** - Use proper types or `unknown`
