#!/bin/sh

# Load Node.js environment for non-interactive shells
# This handles nvm, fnm, volta, and other version managers

# Try to find pnpm in common locations
if [ -z "$(command -v pnpm)" ]; then
    # Try nvm
    if [ -s "$HOME/.nvm/nvm.sh" ]; then
        . "$HOME/.nvm/nvm.sh"
    fi

    # Try fnm
    if [ -s "$HOME/.fnm/fnm" ]; then
        eval "$(fnm env)"
    fi

    # Try volta
    if [ -d "$HOME/.volta" ]; then
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
    fi

    # Try Homebrew Node on macOS
    if [ -d "/opt/homebrew/bin" ]; then
        export PATH="/opt/homebrew/bin:$PATH"
    fi

    # Try common global npm/pnpm locations
    export PATH="$HOME/.local/share/pnpm:$PATH"
    export PATH="$HOME/.pnpm-global/bin:$PATH"
    export PATH="$HOME/Library/pnpm:$PATH"
fi

# Final check for pnpm
if [ -z "$(command -v pnpm)" ]; then
    echo "Error: pnpm not found. Please ensure pnpm is installed and in your PATH."
    exit 1
fi

echo "Running pre-push checks..."

# Run format check on entire project (same as CI)
echo "Checking formatting..."
pnpm format:check || {
    echo ""
    echo "Formatting issues found. Run 'pnpm format' to fix them."
    exit 1
}

# Run lint check on entire project
echo "Linting..."
pnpm lint || {
    echo ""
    echo "Lint issues found. Run 'pnpm lint:fix' to fix them."
    exit 1
}

# Run spell check on entire project
echo "Spell checking..."
pnpm spellcheck || {
    echo ""
    echo "Spelling issues found. Please fix them."
    exit 1
}

echo "Pre-push checks passed!"
